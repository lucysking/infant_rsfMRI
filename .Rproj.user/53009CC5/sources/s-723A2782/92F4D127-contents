---
title: "Multi-dimensional SES at 6 months"
author: "Lucy King"
date: "2/25/2020"
output: html_document
---


```{r}
library(tidyverse)
library(corrr)
library(psych)
library(ggcorrplot)

data_home <- "~/Box/Mooddata_Coordinating/BABIES/Data/final_scored_data/"

prams_file <- paste0(data_home, "PRAMS/prams_alldata_cleaned.csv")
demographics_file <- paste0(data_home, "demographics/demo_6mo_cleaned_final.csv")
crisys_file <- paste0(data_home, "CRISYS/crisys_scored_wf_complete.csv")
lscr_file <- paste0(data_home, "LSCR/lscr_all_data_exp_20200219.csv")
sep_file <- paste0(data_home, "SEP/sep_cleaned_wf.csv")
home_file <- paste0(data_home, "HOME/HOME_SES_cleaned_20200225.csv")
```

```{r}
ses <-
  read_csv(demographics_file) %>% 
  select(
    ID,
    annual_income_num,
    annual_income_num,
    annual_income_txt,
    education, 
    education_txt,
    employment_status_txt,
    partner_educ,
    partner_educ_txt,
    partner_employ_txt,
    mom_pob,
    partner_pob,
    marital_status_txt,
    primarylang,
    income_needs
  ) %>% 
  mutate(
    mom_immigrant = case_when(
      mom_pob == "United States" ~ 0,
      mom_pob == "US" ~ 0, 
      mom_pob == "USA" ~ 0,
      TRUE ~ 1
    ),
    partner_immigrant = case_when(
      partner_pob == "United States" ~ 0,
      partner_pob == "US" ~ 0, 
      partner_pob == "USA" ~ 0,
      TRUE ~ 1
    ),
    marital_partnered = if_else(
      marital_status_txt == "Married/domestic partnership",
      1, 0
    ),
    primary_english = if_else(
      primarylang == "English", 1, 0
    ),
    employed = if_else(
      employment_status_txt == "Employed for wages", 
      1, 0
    ),
    partner_employed = if_else(
      partner_employ_txt == "Employed for wages", 
      1, 0
    )
  ) %>% 
  select(-primarylang, -mom_pob, -partner_pob) %>% 
  left_join(
    read_csv(prams_file) %>% 
      select(ID, preg_att_money),
    by = "ID"
  ) %>% 
  left_join(
    read_csv(crisys_file) %>% 
      select(ID, sixmonth_crisys_ses_total),
    by = "ID"
  ) %>% 
  left_join(
    read_csv(lscr_file) %>% 
      select(ID, lscr_money_post),
    by = "ID"
  ) %>% 
  left_join(
    read_csv(sep_file) %>% 
      select(ID, sixmonth_usstatus_ladder, sixmonth_commstatus_ladder),
    by = "ID"
  ) %>% 
  left_join(
    read_csv(home_file),
    by = "ID"
  ) %>% 
  arrange(ID)
```

# EFA

Numeric variables for dimension reduction

PRAMS
- preg_att_money (when found out pregnant I was worried that I did not have enough money to take care of a baby)

```{r}
ses %>% 
  count(preg_att_money)
```

Demographics
- income to needs
```{r}
ses %>% 
  ggplot(aes(income_needs)) +
  geom_histogram()
```

- education, partner_educ
```{r}
ses %>% 
  ggplot(aes(education)) +
  geom_histogram()

ses %>% 
  count(education_txt) %>% 
  arrange(n)

ses %>% 
  ggplot(aes(partner_educ)) +
  geom_histogram()

ses %>% 
  count(partner_educ_txt) %>% 
  arrange(n)
```
- primary_english
```{r}
ses %>% 
  count(primary_english)
```
- employed, partner_employed
```{r}
ses %>% 
  count(employed)

ses %>% 
  count(partner_employed)
```

CRISYS
- sixmonth_crisys_ses_total
```{r}
ses %>% 
  ggplot(aes(sixmonth_crisys_ses_total)) +
  geom_histogram()
```

SEP
- sixmonth_usstatus_ladder
```{r}
ses %>% 
  ggplot(aes(sixmonth_usstatus_ladder)) +
  geom_histogram()
```

- sixmonth_commstatus_ladder
```{r}
ses %>% 
  ggplot(aes(sixmonth_commstatus_ladder)) +
  geom_histogram()
```

HOME
- pregwork_hours
```{r}
ses %>% 
  ggplot(aes(pregwork_hours)) +
  geom_histogram()
```


## Select variables for EFA
```{r}
ses_efa <-
  ses %>% 
  arrange(ID) %>% 
  select(
    preg_att_money,
    income_needs,
    education,
    primary_english,
    employed,
    sixmonth_crisys_ses_total,
    sixmonth_usstatus_ladder,
    sixmonth_commstatus_ladder,
    pregwork_hours,
    paid_maternity_leave
  ) 
```

## Correlations
```{r}
ses_efa %>% 
  correlate() %>% 
  fashion()
```
    
```{r}
corr_ses_plot <- 
  ses_efa %>%
  select(
    `Prenatal $ worry` = preg_att_money,
    `Income to needs` = income_needs,
    `Maternal education` = education,
    `Primary English` = primary_english,
    `Mother employed` = employed,
    `6-mo $ stress` = sixmonth_crisys_ses_total,
    `Subjective US status` = sixmonth_usstatus_ladder,
    `Subjective community status` = sixmonth_commstatus_ladder,
    `Work hours` = pregwork_hours,
    `Paid maternity leave` = paid_maternity_leave
  ) %>% 
  cor(use = "complete.obs", method = "pearson")

ggcorrplot(corr_ses_plot, hc.order = TRUE)

ggsave("~/Box/lucy_king_files/BABIES/rsfMRI/LENA/ses_corr.png")
```

## Paralell analysis to determine # of factors
```{r}
fa.parallel(ses_efa)
```

## Pearson correlations, varimax rotation
```{r}
# Pearson correlations
efa_3 <- fa(r = ses_efa, nfactors = 3, rotate = "varimax", cor = "cor") 
efa_3
```
Tucker Lewis Index of factoring reliability =  0.689
RMSEA index =  0.117
BIC =  -25.73

# Visualize 3-factor solution
```{r}
factor_names = c(
  "Factor 1:\nStress and Resources", 
  "Factor 2:\nEmployment",
  "Factor 3:\nSubjective Status"
  )

loadings <-
  efa_3$loadings[] %>% 
  data.frame() %>% 
  rownames_to_column("measure") %>% 
  gather(factor, loading, -measure) %>%  
  mutate(factor = as.character(factor(factor, labels = factor_names))) 
  

# get fa.sort() order
order <- 
  loadings %>%
  group_by(measure) %>%
  top_n(1, abs(loading)) %>%
  ungroup() %>%
  arrange(desc(factor), abs(loading)) %>%
  mutate(order = 1:length(levels(factor(loadings$measure)))) %>%
  select(measure, order)
  
# get percent shared variance explained
shared_var <- efa_3$Vaccounted %>%
  data.frame() %>%
  rownames_to_column("stat") %>%
  filter(stat == "Proportion Var") %>%
  select(-stat) %>%
  gather(factor, var) %>%
  mutate(factor = as.character(factor(factor, labels = factor_names))) %>%
  mutate(var = paste0(factor, "\n", round(var, 2)*100, "% var."))

  # make plot
loadings_plot_data <- 
  loadings %>% 
  left_join(order, by = "measure") %>%
  left_join(shared_var, by = "factor") %>%
  mutate(
    measure = recode(
    measure,
    "preg_att_money" = "Prenatal $ worry",
    "annual_income_num" = "Annual income",
    "income_needs" = "Income-to-needs",
    "education" = "Maternal education",
    "primary_english" = "Primary English",
    "employed" = "Mother employed",
    "sixmonth_crisys_ses_total" = "6-mo $ stress",
    "sixmonth_usstatus_ladder" = "Subjective US status",
    "sixmonth_commstatus_ladder" = "Subjective community status",
    "paid_maternity_leave" = "Paid maternity leave",
    "pregwork_hours" = "Work hours"
    )
  ) 

loadings_plot_data %>% 
  ggplot(
    aes(
      x = var, 
      y = reorder(measure, order), 
      fill = loading,
      label = round(loading, 2)
    )
  ) +
  geom_tile(color = "black") +
  geom_text(size = 7, color = "black") +
  scale_fill_distiller(
    limits = c(-1, 1), 
    palette = "RdYlBu",
    guide = guide_colorbar(barheight = 20)
  ) +
  scale_x_discrete(position = "top") +
  theme_minimal() +
  theme(
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 14),
    axis.title = element_blank(), 
    axis.text.y = element_text(size = 18),
    axis.text.x = element_text(size = 17)
  )

ggsave("~/Box/lucy_king_files/BABIES/rsfMRI/LENA/ses_loadings_plot.png", height = 7, width = 10.5)
```

```{r}
efa_3_scores <- factor.scores(x = ses_efa, f = efa_3$loadings, method = "tenBerge")

ID <-
  ses %>% 
  pull(ID)

ses_fa_scores <-
  efa_3_scores$scores %>% 
  as_tibble() %>% 
  cbind(ID) %>% 
  select(
    ID,
    everything()
  ) %>% 
  rename(
    stress_resource = MR2,
    employment = MR1,
    subjective_status = MR3
  )

write_csv(ses_fa_scores, "~/Box/lucy_king_files/BABIES/rsfMRI/data/ses_factors.csv")
  
```

